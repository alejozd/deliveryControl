import React, { useState, useRef } from "react";
import { Toast } from "primereact/toast";
import { Panel } from "primereact/panel";
import SearchBar from "./SearchBar";
import EntregasList from "./EntregasList";
import { Dialog } from "primereact/dialog";
import { Button } from "primereact/button";
import { v4 as uuidv4 } from "uuid";
import axios from "axios";
import config from "../../Config";

function Entregas() {
  const apiUrl = `${config.apiUrl}/Datasnap/rest/TServerMethods1/entregas`;
  const [loading, setLoading] = useState(false);
  const [searchTerm, setSearchTerm] = useState("");
  const [selectedDate, setSelectedDate] = useState(new Date());
  const [products, setProducts] = useState([]);
  const [errorState, setErrorState] = useState(false);
  const [errorMessage, setErrorMessage] = useState("");
  const toast = useRef(null);

  const handleCloseErrorDialog = () => {
    setErrorState(false);
    setErrorMessage("");
  };

  const handleSearch = async () => {
    setLoading(true);
    const requestData = {
      fechaFactura: selectedDate.toLocaleDateString("es-CO", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
      }),
      criterio: searchTerm,
    };

    try {
      const response = await fetchEntregas(requestData);
      if (response.status === 200) {
        const data = response.data;
        const newData = data.result.map((entrega) => ({
          ...entrega,
          detalle: entrega.detalle.map((detalle) => ({
            ...detalle,
            id: uuidv4(),
          })),
        }));
        setProducts(newData);
      } else {
        console.error("Error al buscar entregas:", response.statusText);
      }
    } catch (error) {
      console.error("Error en la búsqueda de entregas:", error);
    } finally {
      setLoading(false);
    }
  };

  const fetchEntregas = async (requestData) => {
    try {
      const response = await axios.post(apiUrl, requestData, {
        headers: {
          "Content-Type": "application/json",
        },
      });
      return response;
    } catch (error) {
      handleError(error);
    }
  };

  const handleError = (error) => {
    if (error.message.includes("Network Error")) {
      setErrorState(true);
      setErrorMessage(
        "No se pudo conectar con el servidor. Por favor, verifica tu conexión e inténtalo de nuevo más tarde."
      );
    } else {
      setErrorState(true);
      setErrorMessage(
        "Ocurrió un error. Por favor, inténtalo de nuevo más tarde."
      );
    }
  };

  const handleUpdateAceptapotradatos = (idcliente, accepted) => {
    const updatedProducts = products.map((product) =>
      product.idcliente === idcliente
        ? { ...product, aceptapotradatos: accepted ? 1 : 0 }
        : product
    );
    setProducts(updatedProducts);
  };

  return (
    <div style={{ paddingTop: "5px" }}>
      <Panel header="Búsqueda de Facturas" toggleable>
        <div className="card">
          <SearchBar
            selectedDate={selectedDate}
            setSelectedDate={setSelectedDate}
            searchTerm={searchTerm}
            setSearchTerm={setSearchTerm}
            handleSearch={handleSearch}
            loading={loading}
          />
        </div>
      </Panel>

      <Toast ref={toast} />
      <EntregasList
        products={products}
        setProducts={setProducts}
        toast={toast}
        handleSearch={handleSearch}
        onUpdateAceptapotradatos={handleUpdateAceptapotradatos}
        loading={loading}
      />
      <Dialog
        visible={errorState}
        onHide={handleCloseErrorDialog}
        header="Error"
        modal
        style={{ width: "300px" }}
      >
        <div>
          <p>{errorMessage}</p>
          <Button
            label="Cerrar"
            icon="pi pi-times"
            severity="danger"
            text
            style={{ marginTop: "10px" }}
            size="small"
            onClick={handleCloseErrorDialog}
          />
        </div>
      </Dialog>
    </div>
  );
}

export default Entregas;
