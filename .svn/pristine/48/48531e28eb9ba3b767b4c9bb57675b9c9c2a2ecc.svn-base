import React, { useState, useEffect } from 'react';
import { DataTable } from 'primereact/datatable';
import { Column } from 'primereact/column';
import { Panel } from 'primereact/panel';
import { Calendar } from 'primereact/calendar';
import { Button } from 'primereact/button';
import { Toolbar } from 'primereact/toolbar';
import { addLocale } from 'primereact/api';
import { Dialog } from 'primereact/dialog';
import DetalleEntrega from './DetalleEntrega';
import axios from 'axios';

const ConsultaEntregas = () => {
    const [entregas, setEntregas] = useState([]);
    const [loading, setLoading] = useState(false);
    const [dates, setDates] = useState(null);
    const [fechaIni, setFechaIni] = useState(null);
    const [fechaFin, setFechaFin] = useState(null);
    const [selectedEntrega, setSelectedEntrega] = useState(null);
    const [showDetalleModal, setShowDetalleModal] = useState(false);
    const [numeroEntrega, setNumeroEntrega] = useState(null);
    const [errorState, setErrorState] = useState(false);
    const [errorMessage, setErrorMessage] = useState('');

    addLocale('es', {
        firstDayOfWeek: 1,
        showMonthAfterYear: true,
        dayNames: ['domingo', 'lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado'],
        dayNamesShort: ['dom', 'lun', 'mar', 'mié', 'jue', 'vie', 'sáb'],
        dayNamesMin: ['D', 'L', 'M', 'X', 'J', 'V', 'S'],
        monthNames: ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'],
        monthNamesShort: ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'],
        today: 'Hoy',
        clear: 'Limpiar'
    });

    const handleCloseErrorDialog = () => {
        setErrorState(false);
        setErrorMessage('');
    };

    const handleSearch = async () => {
        try {
            setLoading(true);
            const requestData = {
                fechaIni: fechaIni.toLocaleDateString("es-CO"),
                fechaFin: fechaFin.toLocaleDateString("es-CO"),
            };
            console.log('JSON enviado al backend:', requestData);
            const response = await axios.put('http://192.168.20.38:8080/Datasnap/rest/TServerMethods1/ListaEntregas', requestData);

            if (response.data.status === 200) {
                setEntregas(response.data.data);
                console.log('Entregas:', response.data.data);
            } else {
                console.error('Error en la respuesta:', response.data.error);
                setErrorMessage(response.data.error);
            }
        } catch (error) {
            if (error.message === "Network Error") {
                setErrorState(true);
                setErrorMessage("Error de red: No se puede conectar al servidor. Por favor, verifica tu conexión a Internet o inténtalo más tarde.");
            } else {
                setErrorState(true);
                setErrorMessage(`Error al realizar la solicitud: ${error.message}`);
            }
            console.error('Error al realizar la solicitud:', error.message);
        } finally {
            setLoading(false);
        }
    };

    const showDetailModal = (entrega) => {
        // console.log('entrega:', entrega);
        setSelectedEntrega(entrega.identrega);
        setNumeroEntrega(entrega.numeroentrega);
        // console.log('numentrega:', entrega.numeroentrega);
        setShowDetalleModal(true);
    };

    const onCloseDetalleModal = () => {
        setShowDetalleModal(false);
    };
    const onHide = () => {
        setSelectedEntrega(null);
        setShowDetalleModal(false);
    };

    const renderFooter = () => {
        return (
            <div>
                <Button label="Cerrar" icon="pi pi-times" onClick={onHide} />
            </div>
        );
    };

    useEffect(() => {
        // Si solo se selecciona una fecha, asignarla tanto como fecha inicial como fecha final
        if (fechaIni && !fechaFin) {
            setFechaFin(fechaIni);
        } else if (!fechaIni && fechaFin) {
            setFechaIni(fechaFin);
        }
    }, [fechaIni, fechaFin]);

    const handleDateChange = (e) => {
        setDates(e.value);

        if (e.value && e.value.length > 0) {
            setFechaIni(e.value[0]);
            if (e.value.length === 2) {
                setFechaFin(e.value[1]);
            } else {
                setFechaFin(e.value[0]);
            }
        } else {
            setFechaIni(null);
            setFechaFin(null);
        }
    };

    return (
        <div>
            <Panel header="Consulta de Entregas" toggleable>
                <Toolbar
                    start={
                        <>
                            <Calendar value={dates}
                                onChange={handleDateChange}
                                locale="es"
                                selectionMode="range"
                                showIcon
                                readOnlyInput
                                dateFormat="dd/mm/yy"
                            />
                        </>
                    }
                    end={
                        <>
                            <Button label="Buscar"
                                icon="pi pi-search"
                                className="p-mt-2"
                                loading={loading}
                                onClick={handleSearch} />
                        </>
                    }
                />
            </Panel>
            <DataTable value={entregas} emptyMessage="No se han encontrado resultados" showGridlines stripedRows className="p-datatable-sm"
                paginator rows={10} rowsPerPageOptions={[5, 10, 25, 50]}>
                <Column field="nombrecliente" header="Nombre Cliente" />
                <Column field="numeroentrega" header="Número Entrega" />
                <Column field="fechaentrega" header="Fecha Entrega" />
                <Column field="numfactura" header="Número Factura" />
                <Column field="fechafactura" header="Fecha Factura" />
                <Column field="vendedor" header="Vendedor" />
                <Column
                    body={(rowData) => (
                        <Button
                            icon="pi pi-info-circle"
                            onClick={() => showDetailModal(rowData)}
                        />
                    )}
                />
            </DataTable>
            <Dialog
                // header="Entrega"
                header={`Entrega ${numeroEntrega}`}
                visible={showDetalleModal}
                onHide={onHide}
            // footer={renderFooter()}
            >
                {showDetalleModal && (
                    <DetalleEntrega
                        idEntrega={selectedEntrega}
                        onClose={onCloseDetalleModal}
                        entregaData={entregas.find(entrega => entrega.identrega === selectedEntrega)}
                    />
                )}
            </Dialog>
            <Dialog
                visible={errorState}
                onHide={handleCloseErrorDialog}
                header="Error"
                modal
                style={{ width: '300px' }}
            >
                <div>
                    <p>{errorMessage}</p>
                    <Button label="Cerrar" icon="pi pi-times"
                        severity='danger'
                        text
                        style={{ marginTop: '10px' }}
                        size="small"
                        onClick={handleCloseErrorDialog} />
                </div>
            </Dialog>
        </div>
    );
};

export default ConsultaEntregas;