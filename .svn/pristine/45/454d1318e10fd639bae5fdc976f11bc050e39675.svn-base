import React, { useState, useEffect } from "react";
import { Dialog } from "primereact/dialog";
import { InputText } from "primereact/inputtext";
import { Button } from "primereact/button";
import { Checkbox } from "primereact/checkbox";
import { Dropdown } from "primereact/dropdown";
import { TabView, TabPanel } from "primereact/tabview";
import config from "../Config";
import axios from "axios";
import Potradatos from "./Potradatos";

const ClientCreation = ({
  visible,
  onHide,
  onCustomerCreated,
  selectedCustomer,
}) => {
  const apiUrlCrearCliente = `${config.apiUrl}/Datasnap/rest/TServerMethods1/NewCliente`;
  const apiUrlVendedores = `${config.apiUrl}/Datasnap/rest/TServerMethods1/ListaVendedores`;
  const apiUrlSegmentacion = `${config.apiUrl}/Datasnap/rest/TServerMethods1/ListaSegmentacion`;

  const [nombrecliente, setNombreCliente] = useState("");
  const [identidad, setIdentidad] = useState("");
  const [telmovil, setTelmovil] = useState("");
  const [direccion, setDireccion] = useState("");
  const [email, setEmail] = useState("");
  const [aceptapotradatos, setAceptapotradatos] = useState(false);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [isFormValid, setIsFormValid] = useState(false);
  const [vendedores, setVendedores] = useState([]);
  const [selectedVendedor, setSelectedVendedor] = useState(null);
  const [segmentList, setSegmentList] = useState([]);
  const [selectedSegment, setSelectedSegment] = useState(null);
  const [dialogVisible, setDialogVisible] = useState(false);
  const [activeIndex, setActiveIndex] = useState(0);

  const resetForm = () => {
    setNombreCliente("");
    setIdentidad("");
    setTelmovil("");
    setDireccion("");
    setEmail("");
    setAceptapotradatos(false);
    setSelectedVendedor(null);
    setSelectedSegment(null);
  };

  useEffect(() => {
    const fetchVendedores = async () => {
      try {
        const response = await axios.get(apiUrlVendedores);
        if (response.status === 200) {
          setVendedores(response.data.result);
        } else {
          console.error("Error fetching vendedores:", response.data.error);
        }
      } catch (error) {
        console.error("Error fetching vendedores:", error);
      }
    };

    const fetchSegments = async () => {
      try {
        setLoading(true);
        const response = await axios.get(apiUrlSegmentacion);
        if (response.status === 200) {
          const formattedSegments = response.data.result.map((segment) => ({
            label: segment.nombresegmento,
            value: segment.idsegmento,
          }));
          setSegmentList(formattedSegments);
        } else {
          console.error("Error fetching segments:", response.data.error);
        }
        setLoading(false);
      } catch (error) {
        console.error("Error fetching segments:", error);
        setLoading(false);
      }
    };

    fetchVendedores();
    fetchSegments();
  }, [apiUrlSegmentacion, apiUrlVendedores]);

  useEffect(() => {
    if (selectedCustomer) {
      setNombreCliente(selectedCustomer.nombrecliente);
      setIdentidad(selectedCustomer.identidad);
      setTelmovil(selectedCustomer.telmovil);
      setDireccion(selectedCustomer.direccion);
      setEmail(selectedCustomer.email);
      setAceptapotradatos(selectedCustomer.aceptapotradatos === 1);

      // Espera hasta que los datos de vendedores y segmentos estén disponibles
      if (vendedores.length > 0 && segmentList.length > 0) {
        const vendedorSeleccionado = vendedores.find(
          (vendedor) => vendedor.identidadve === selectedCustomer.identidadve
        );
        setSelectedVendedor(vendedorSeleccionado);
        const segmentoSeleccionado = segmentList.find(
          (segment) => segment.value === selectedCustomer.idsegmento
        );
        setSelectedSegment(segmentoSeleccionado.value);
      }
    } else {
      resetForm();
    }
  }, [selectedCustomer, vendedores, segmentList]);

  useEffect(() => {
    if (
      nombrecliente.trim() !== "" &&
      identidad.trim() !== "" &&
      telmovil.trim() !== "" &&
      direccion.trim() !== "" &&
      email.trim() !== "" &&
      aceptapotradatos &&
      selectedVendedor !== null &&
      selectedSegment !== null
    ) {
      setIsFormValid(true);
    } else {
      setIsFormValid(false);
    }
  }, [
    nombrecliente,
    identidad,
    telmovil,
    direccion,
    email,
    aceptapotradatos,
    selectedVendedor,
    selectedSegment,
  ]);

  const handleCreate = async () => {
    setLoading(true);
    console.log("selectedSegment", selectedSegment);
    const newCustomer = {
      esnuevo: selectedCustomer ? 0 : 1,
      idcliente: selectedCustomer ? selectedCustomer.idcliente : null,
      nombrecliente: nombrecliente,
      identidad: identidad,
      telmovil: telmovil,
      direccion: direccion,
      email: email,
      aceptapotradatos: aceptapotradatos ? 1 : 0,
      identidadve: selectedVendedor.identidadve,
      idsegmento: selectedSegment,
    };
    console.log("datos Cliente:", newCustomer);
    try {
      const response = await axios.put(apiUrlCrearCliente, newCustomer);
      if (response.data.status === 200) {
        onCustomerCreated(newCustomer);
        onHide();
      } else {
        setError(response.data.error || "Error en la respuesta");
        console.error(response.data.error);
      }
    } catch (error) {
      setError("Error al realizar la solicitud: " + error.message);
      console.error(error);
    } finally {
      setLoading(false);
    }
  };

  const handleCheckboxChange = (e) => {
    console.log("aceptapotradatos", e.checked);
    if (!e.checked) {
      setAceptapotradatos(false);
    } else {
      setDialogVisible(true);
    }
  };

  const handleAcceptPolicy = () => {
    setAceptapotradatos(true);
    setDialogVisible(false);
  };

  const handleRejectPolicy = () => {
    setAceptapotradatos(false);
    setDialogVisible(false);
  };

  const footerContent = (
    <div style={{ marginTop: "1em" }}>
      <Button
        label="Crear"
        severity="success"
        onClick={handleCreate}
        autoFocus
        size="small"
        icon="pi pi-check"
        disabled={!isFormValid || loading}
      />
      <Button
        label="Cancelar"
        severity="danger"
        onClick={onHide}
        text
        raised
        size="small"
        icon="pi pi-times"
        disabled={loading}
      />
    </div>
  );

  return (
    <>
      <Dialog
        visible={visible}
        style={{ width: "50vw" }}
        onHide={onHide}
        header={selectedCustomer ? "Editar Cliente" : "Crear Nuevo Cliente"}
        modal
        className="p-fluid"
        footer={footerContent}
      >
        <div className="card">
          <div className="flex mb-2 gap-2 justify-content-end">
            <Button
              onClick={() => setActiveIndex(0)}
              className="w-2rem h-2rem p-0"
              rounded
              outlined={activeIndex !== 0}
              label="1"
            />
            <Button
              onClick={() => setActiveIndex(1)}
              className="w-2rem h-2rem p-0"
              rounded
              outlined={activeIndex !== 1}
              label="2"
            />
            <Button
              onClick={() => setActiveIndex(2)}
              className="w-2rem h-2rem p-0"
              rounded
              outlined={activeIndex !== 2}
              label="3"
            />
          </div>
          <TabView
            activeIndex={activeIndex}
            onTabChange={(e) => setActiveIndex(e.index)}
          >
            <TabPanel header="Datos Basicos">
              <div className="card">
                {error && <p style={{ color: "red" }}>{error}</p>}
                <div className="labelinput">
                  <label htmlFor="nombreCliente">Nombre del Cliente</label>
                  <InputText
                    className="inputtext"
                    id="nombreCliente"
                    value={nombrecliente}
                    onChange={(e) => setNombreCliente(e.target.value)}
                    style={{ width: "100%" }}
                  />
                </div>
                <div className="labelinput">
                  <label htmlFor="identidad">Identidad</label>
                  <InputText
                    className="inputtext"
                    id="identidad"
                    value={identidad}
                    onChange={(e) => setIdentidad(e.target.value)}
                    style={{ width: "100%" }}
                  />
                </div>
                <div className="labelinput">
                  <label htmlFor="telmovil">Teléfono</label>
                  <InputText
                    className="inputtext"
                    id="telmovil"
                    value={telmovil}
                    onChange={(e) => setTelmovil(e.target.value)}
                    style={{ width: "100%" }}
                  />
                </div>
                <div className="labelinput">
                  <label htmlFor="direccion">Dirección</label>
                  <InputText
                    className="inputtext"
                    id="direccion"
                    value={direccion}
                    onChange={(e) => setDireccion(e.target.value)}
                    style={{ width: "100%" }}
                  />
                </div>
                <div className="labelinput">
                  <label htmlFor="email">Correo electrónico</label>
                  <InputText
                    className="inputtext"
                    id="email"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    style={{ width: "100%" }}
                  />
                </div>
                <div className="labelinput">
                  <label htmlFor="vendedorId">Vendedor</label>
                  <Dropdown
                    className="inputtext"
                    id="vendedorId"
                    value={selectedVendedor}
                    onChange={(e) => setSelectedVendedor(e.value)}
                    options={vendedores}
                    optionLabel="nombreve"
                    placeholder="Seleccione un vendedor"
                    required
                  />
                </div>
                <div className="labelinput">
                  <label htmlFor="idsegmento">Segmento</label>
                  <Dropdown
                    className="inputtext"
                    id="idsegmento"
                    value={selectedSegment}
                    onChange={(e) => setSelectedSegment(e.value)}
                    options={segmentList}
                    optionLabel="label"
                    placeholder="Seleccionar Segmento"
                    required
                  />
                </div>
                <div style={{ marginTop: "1em" }}>
                  <Checkbox
                    style={{ marginRight: "0.5em" }}
                    inputId="aceptapotradatos"
                    checked={aceptapotradatos}
                    onChange={handleCheckboxChange}
                  />
                  <label htmlFor="aceptapotradatos">
                    Acepta política de tratamiento de datos
                  </label>
                </div>
              </div>
            </TabPanel>
            <TabPanel header="Datos adicionales">
              <div className="card"></div>
            </TabPanel>
            <TabPanel header="Datos adicionales FEL">
              <div className="card"></div>
            </TabPanel>
          </TabView>
        </div>
      </Dialog>

      <Potradatos
        visible={dialogVisible}
        onHide={() => setDialogVisible(false)}
        idCliente={selectedCustomer ? selectedCustomer.idcliente : null}
        aceptaTratamiento={
          selectedCustomer ? selectedCustomer.aceptapotradatos : 0
        }
        onAccept={handleAcceptPolicy}
      />
    </>
  );
};

export default ClientCreation;
