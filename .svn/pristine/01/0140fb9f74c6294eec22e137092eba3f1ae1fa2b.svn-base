import React, { useState, useEffect } from "react";
import { Dialog } from "primereact/dialog";
import { Button } from "primereact/button";
import { InputNumber } from "primereact/inputnumber";
import { Column } from "primereact/column";
import { DataTable } from "primereact/datatable";
import "./SearchDialogListBox.css";

const ProductSearchDialog = ({
  showDialogProduct,
  setShowDialogProduct,
  products,
  onAcceptSelection,
  selectedBodega,
}) => {
  const [expandedRows, setExpandedRows] = useState(null);
  const [localProducts, setLocalProducts] = useState([]);
  const [loading, setLoading] = useState(false);
  const showRowExpansion = selectedBodega === -1;

  useEffect(() => {
    if (products.length > 0) {
      setLoading(true);
      const initializedProducts = products.map((product) => {
        // Si no es múltiples bodegas, filtrar solo la bodega seleccionada
        const filteredBodegas =
          selectedBodega > 0
            ? product.bodegas.filter(
                (b) => Number(b.codigobodega) === Number(selectedBodega)
              )
            : product.bodegas;

        return {
          ...product,
          cantidad: product.cantidad || 0,
          bodegas: filteredBodegas.map((bodega) => ({
            ...bodega,
            cantidad: bodega.cantidad || 0,
            nombrebodega: bodega.s_nombre || bodega.nombrebodega,
            existencia: bodega.s_existencia || bodega.existencia,
          })),
          existencia_total:
            selectedBodega > 0
              ? filteredBodegas[0]?.s_existencia ||
                filteredBodegas[0]?.existencia ||
                0
              : product.existencia_total ||
                product.bodegas.reduce(
                  (sum, b) => sum + (b.s_existencia || b.existencia || 0),
                  0
                ),
          uniqueKey: `${product.codigo}-${product.subcodigo}`,
        };
      });

      setLocalProducts(initializedProducts);
      setExpandedRows(null);
      setLoading(false);
    }
  }, [products, selectedBodega]);

  const handleCantidadChange = (producto, nuevaCantidad) => {
    const updatedProducts = localProducts.map((p) => {
      if (p.uniqueKey === producto.uniqueKey) {
        return { ...p, cantidad: Math.min(nuevaCantidad, p.existencia_total) };
      }
      return p;
    });
    setLocalProducts(updatedProducts);
  };

  const handleCantidadBodegaChange = (producto, bodegaId, nuevaCantidad) => {
    const updatedProducts = localProducts.map((p) => {
      if (p.uniqueKey === producto.uniqueKey) {
        const updatedBodegas = p.bodegas.map((b) => {
          if (b.codigobodega === bodegaId) {
            return { ...b, cantidad: Math.min(nuevaCantidad, b.existencia) };
          }
          return b;
        });

        const cantidadTotal = updatedBodegas.reduce(
          (sum, b) => sum + b.cantidad,
          0
        );

        return { ...p, bodegas: updatedBodegas, cantidad: cantidadTotal };
      }
      return p;
    });
    setLocalProducts(updatedProducts);
  };

  const rowExpansionTemplate = (product) => {
    return (
      <div className="p-3">
        <h5>Disponibilidad en Bodegas</h5>
        <DataTable
          value={product.bodegas}
          size="small"
          className="p-datatable-sm"
          lazy
        >
          <Column field="nombrebodega" header="Bodega" />
          <Column field="existencia" header="Existencia" />
          <Column
            header="Cantidad"
            body={(bodega) => (
              <InputNumber
                value={bodega.cantidad}
                onValueChange={(e) =>
                  handleCantidadBodegaChange(
                    product,
                    bodega.codigobodega,
                    e.value
                  )
                }
                min={0}
                max={bodega.existencia}
                showButtons
                mode="decimal"
              />
            )}
          />
        </DataTable>
      </div>
    );
  };

  const onHide = () => {
    setShowDialogProduct(false);
  };

  const acceptSelection = () => {
    const selectedProducts = localProducts.filter((p) => p.cantidad > 0);
    if (selectedProducts.length > 0) {
      onAcceptSelection(selectedProducts);
      onHide();
    } else {
      alert("Por favor seleccione al menos un producto con cantidad mayor a 0");
    }
  };

  return (
    <Dialog
      header="Selección de Productos"
      visible={showDialogProduct}
      style={{ width: "90vw", maxWidth: "1200px" }}
      onHide={onHide}
      footer={
        <div>
          <Button
            label="Aceptar"
            icon="pi pi-check"
            onClick={acceptSelection}
            autoFocus
            className="p-button-success"
          />
          <Button
            label="Cancelar"
            icon="pi pi-times"
            onClick={onHide}
            className="p-button-secondary"
          />
        </div>
      }
    >
      <DataTable
        value={localProducts}
        dataKey="uniqueKey"
        expandedRows={expandedRows}
        onRowToggle={(e) => setExpandedRows(e.data)}
        rowExpansionTemplate={rowExpansionTemplate}
        emptyMessage="No se encontraron productos"
        scrollable
        scrollHeight="flex"
        paginator
        rows={10}
        rowsPerPageOptions={[10, 20, 30]}
        loading={loading}
      >
        {/* <Column expander style={{ width: "3em" }} hidden />*/}
        <Column expander style={{ width: "3em" }} hidden={selectedBodega > 0} />

        <Column
          field="nombreproducto"
          header="Producto"
          style={{ minWidth: "200px" }}
        />
        <Column
          field="referencia"
          header="Referencia"
          style={{ width: "120px" }}
        />
        {selectedBodega > 0 && (
          <Column
            field="nombrebodega"
            header="Bodega"
            body={(products) => {
              // Filtrar la bodega seleccionada por el ID de la bodega
              const selectedBodegaData = products.bodegas.find(
                (bodega) =>
                  Number(bodega.codigobodega) === Number(selectedBodega)
              );
              return (
                <span>
                  {selectedBodegaData
                    ? selectedBodegaData.nombrebodega || "No disponible"
                    : "No disponible"}
                </span>
              );
            }}
            style={{ width: "150px" }}
          />
        )}

        <Column
          field="existencia_total"
          header={selectedBodega === 0 ? "Existencia Total" : "Existencia"}
          style={{ width: "120px" }}
        />

        <Column
          header="Cantidad Total"
          style={{ width: "100px" }}
          body={(product) => {
            if (showRowExpansion) {
              return (
                <div className="text-center">
                  <span className="p-tag">{product.cantidad || 0}</span>
                </div>
              );
            } else {
              return (
                <InputNumber
                  value={product.cantidad}
                  onValueChange={(e) => handleCantidadChange(product, e.value)}
                  min={0}
                  max={product.existencia_total}
                  showButtons
                  mode="decimal"
                  locale="en-US"
                  decimalSeparator="."
                  thousandSeparator=","
                  inputStyle={{ width: "60px" }} // Ajusta solo el input interno
                  buttonLayout="horizontal" // Opcional: pone los botones + y - a los lados
                  decrementButtonClassName="p-button-secondary"
                  incrementButtonClassName="p-button-secondary"
                />
              );
            }
          }}
        />
      </DataTable>
    </Dialog>
  );
};

export default ProductSearchDialog;
