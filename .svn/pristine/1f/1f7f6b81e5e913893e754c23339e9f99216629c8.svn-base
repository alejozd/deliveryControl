import React, { useState, useEffect } from "react";
import { DataTable } from "primereact/datatable";
import { Column } from "primereact/column";
import { Panel } from "primereact/panel";
import { Calendar } from "primereact/calendar";
import { Button } from "primereact/button";
import { Toolbar } from "primereact/toolbar";
import { addLocale } from "primereact/api";
import { Dialog } from "primereact/dialog";
import { FilterMatchMode, FilterOperator } from "primereact/api";
import { IconField } from "primereact/iconfield";
import { InputIcon } from "primereact/inputicon";
import { InputText } from "primereact/inputtext";
import DetalleEntrega from "./DetalleEntrega";
import config from "../../Config";
import axios from "axios";

const ConsultaEntregas = () => {
  const apiUrl = `${config.apiUrl}/Datasnap/rest/TServerMethods1/ListaEntregas`;
  const [entregas, setEntregas] = useState([]);
  const [loading, setLoading] = useState(false);
  const [dates, setDates] = useState([new Date(), new Date()]);
  const [fechaIni, setFechaIni] = useState(dates[0]);
  const [fechaFin, setFechaFin] = useState(dates[1]);
  const [selectedEntrega, setSelectedEntrega] = useState(null);
  const [showDetalleModal, setShowDetalleModal] = useState(false);
  const [numeroEntrega, setNumeroEntrega] = useState(null);
  const [errorState, setErrorState] = useState(false);
  const [errorMessage, setErrorMessage] = useState("");
  const [filters, setFilters] = useState(null);
  const [globalFilterValue, setGlobalFilterValue] = useState("");

  addLocale("es", {
    firstDayOfWeek: 1,
    showMonthAfterYear: true,
    dayNames: [
      "domingo",
      "lunes",
      "martes",
      "miércoles",
      "jueves",
      "viernes",
      "sábado",
    ],
    dayNamesShort: ["dom", "lun", "mar", "mié", "jue", "vie", "sáb"],
    dayNamesMin: ["D", "L", "M", "X", "J", "V", "S"],
    monthNames: [
      "enero",
      "febrero",
      "marzo",
      "abril",
      "mayo",
      "junio",
      "julio",
      "agosto",
      "septiembre",
      "octubre",
      "noviembre",
      "diciembre",
    ],
    monthNamesShort: [
      "ene",
      "feb",
      "mar",
      "abr",
      "may",
      "jun",
      "jul",
      "ago",
      "sep",
      "oct",
      "nov",
      "dic",
    ],
    today: "Hoy",
    clear: "Limpiar",
  });

  const handleCloseErrorDialog = () => {
    setErrorState(false);
    setErrorMessage("");
  };

  const handleSearch = async () => {
    try {
      setLoading(true);
      // Asignar una fecha por defecto si las fechas son null
      const fechaInicio = fechaIni || new Date();
      const fechaFinal = fechaFin || new Date();
      const requestData = {
        fechaIni: fechaInicio.toLocaleDateString("es-CO", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
        }),
        fechaFin: fechaFinal.toLocaleDateString("es-CO", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
        }),
      };
      // console.log('JSON enviado al backend:', requestData);
      // const response = await axios.put('http://192.168.20.38:8080/Datasnap/rest/TServerMethods1/ListaEntregas', requestData);
      const response = await axios.put(apiUrl, requestData);

      if (response.data.status === 200) {
        setEntregas(response.data.data);
        console.log("Entregas:", response.data.data);
      } else {
        console.error("Error en la respuesta:", response.data.error);
        setErrorMessage(response.data.error);
      }
    } catch (error) {
      if (error.message === "Network Error") {
        setErrorState(true);
        setErrorMessage(
          "Error de red: No se puede conectar al servidor. Por favor, verifica tu conexión a Internet o inténtalo más tarde."
        );
      } else {
        setErrorState(true);
        setErrorMessage(`Error al realizar la solicitud: ${error.message}`);
      }
      console.error("Error al realizar la solicitud:", error.message);
    } finally {
      setLoading(false);
    }
  };

  const showDetailModal = (entrega) => {
    // console.log('entrega:', entrega);
    setSelectedEntrega(entrega.identrega);
    setNumeroEntrega(entrega.numeroentrega);
    // console.log('numentrega:', entrega.numeroentrega);
    setShowDetalleModal(true);
  };

  const onCloseDetalleModal = () => {
    setShowDetalleModal(false);
  };
  const onHide = () => {
    setSelectedEntrega(null);
    setShowDetalleModal(false);
  };

  // const renderFooter = () => {
  //   return (
  //     <div>
  //       <Button label="Cerrar" icon="pi pi-times" onClick={onHide} />
  //     </div>
  //   );
  // };

  useEffect(() => {
    // Si solo se selecciona una fecha, asignarla tanto como fecha inicial como fecha final
    if (fechaIni && !fechaFin) {
      setFechaFin(fechaIni);
    } else if (!fechaIni && fechaFin) {
      setFechaIni(fechaFin);
    }
    initFilters();
  }, [fechaIni, fechaFin]);

  const handleDateChange = (e) => {
    setDates(e.value);

    if (e.value && e.value.length > 0) {
      setFechaIni(e.value[0]);
      if (e.value.length === 2) {
        setFechaFin(e.value[1]);
      } else {
        setFechaFin(e.value[0]);
      }
    } else {
      setFechaIni(null);
      setFechaFin(null);
    }
  };

  const clearFilter = () => {
    initFilters();
  };

  const onGlobalFilterChange = (e) => {
    const value = e.target.value;
    let _filters = { ...filters };

    _filters["global"].value = value;

    setFilters(_filters);
    setGlobalFilterValue(value);
  };

  const initFilters = () => {
    setFilters({
      global: { value: null, matchMode: FilterMatchMode.CONTAINS },
      nombrecliente: {
        operator: FilterOperator.AND,
        constraints: [{ value: null, matchMode: FilterMatchMode.STARTS_WITH }],
      },
      numeroentrega: {
        operator: FilterOperator.AND,
        constraints: [{ value: null, matchMode: FilterMatchMode.STARTS_WITH }],
      },
      fechaentrega: {
        operator: FilterOperator.AND,
        constraints: [{ value: null, matchMode: FilterMatchMode.STARTS_WITH }],
      },
      numfactura: {
        operator: FilterOperator.AND,
        constraints: [{ value: null, matchMode: FilterMatchMode.STARTS_WITH }],
      },
      fechafactura: {
        operator: FilterOperator.AND,
        constraints: [{ value: null, matchMode: FilterMatchMode.STARTS_WITH }],
      },
      vendedor: {
        operator: FilterOperator.AND,
        constraints: [{ value: null, matchMode: FilterMatchMode.STARTS_WITH }],
      },
    });
  };

  const header = (
    <div className="flex justify-content-between">
      <Button
        type="button"
        icon="pi pi-filter-slash"
        label="Limpiar"
        outlined
        onClick={clearFilter}
      />
      <span className="p-input-icon-right">
        <IconField iconPosition="left">
          <InputIcon className="pi pi-search" />
          <InputText
            value={globalFilterValue}
            onChange={onGlobalFilterChange}
            placeholder="Palabra clave"
          />
        </IconField>
      </span>
    </div>
  );

  return (
    <div style={{ paddingTop: "5px" }}>
      <Panel header="Consulta de Entregas" toggleable>
        <Toolbar
          start={
            <>
              <Calendar
                value={dates}
                onChange={handleDateChange}
                locale="es"
                selectionMode="range"
                showIcon
                readOnlyInput
                dateFormat="dd/mm/yy"
                hideOnRangeSelection
              />
            </>
          }
          end={
            <>
              <Button
                label="Buscar"
                icon="pi pi-search"
                className="p-mt-2"
                loading={loading}
                onClick={handleSearch}
              />
            </>
          }
        />
      </Panel>
      <div style={{ paddingTop: "5px" }}>
        <DataTable
          value={entregas}
          loading={loading}
          emptyMessage="No se han encontrado resultados"
          showGridlines
          stripedRows
          paginator
          rows={10}
          rowsPerPageOptions={[5, 10, 25, 50]}
          scrollable
          scrollHeight="flex"
          paginatorTemplate="FirstPageLink PrevPageLink PageLinks NextPageLink LastPageLink CurrentPageReport RowsPerPageDropdown"
          currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
          sortField={["numfactura, fechafactura"]}
          sortOrder={-1}
          filters={filters}
          globalFilterFields={[
            "nombrecliente",
            "numeroentrega",
            "fechaentrega",
            "numfactura",
            "fechafactura",
            "vendedor",
          ]}
          header={header}
        >
          <Column
            field="nombrecliente"
            header="Nombre Cliente"
            sortable
            filter
            filterPlaceholder="Buscar por nombre"
            filterField="nombrecliente"
          />
          <Column
            field="numeroentrega"
            header="Número Entrega"
            sortable
            filter
            filterPlaceholder="Buscar por número de entrega"
            filterField="numeroentrega"
          />
          <Column
            field="fechaentrega"
            header="Fecha Entrega"
            sortable
            filter
            filterPlaceholder="Buscar por fecha de entrega"
            filterField="fechaentrega"
          />
          <Column
            field="numfactura"
            header="Número Factura"
            sortable
            filter
            filterPlaceholder="Buscar por número de factura"
            filterField="numfactura"
          />
          <Column
            field="fechafactura"
            header="Fecha Factura"
            sortable
            filter
            filterPlaceholder="Buscar por fecha de factura"
            filterField="fechafactura"
          />
          <Column
            field="vendedor"
            header="Vendedor"
            sortable
            filter
            filterPlaceholder="Buscar por vendedor"
            filterField="vendedor"
          />
          <Column
            body={(rowData) => (
              <Button
                icon="pi pi-id-card"
                rounded
                text
                size="large"
                onClick={() => showDetailModal(rowData)}
              />
            )}
            header="Detalle"
            bodyStyle={{ textAlign: "center" }}
          />
        </DataTable>
      </div>
      <Dialog
        // header="Entrega"
        header={`Entrega ${numeroEntrega}`}
        visible={showDetalleModal}
        onHide={onHide}
        // footer={renderFooter()}
      >
        {showDetalleModal && (
          <DetalleEntrega
            idEntrega={selectedEntrega}
            onClose={onCloseDetalleModal}
            entregaData={entregas.find(
              (entrega) => entrega.identrega === selectedEntrega
            )}
          />
        )}
      </Dialog>
      <Dialog
        visible={errorState}
        onHide={handleCloseErrorDialog}
        header="Error"
        modal
        style={{ width: "300px" }}
      >
        <div>
          <p>{errorMessage}</p>
          <Button
            label="Cerrar"
            icon="pi pi-times"
            severity="danger"
            text
            style={{ marginTop: "10px" }}
            size="small"
            onClick={handleCloseErrorDialog}
          />
        </div>
      </Dialog>
    </div>
  );
};

export default ConsultaEntregas;
