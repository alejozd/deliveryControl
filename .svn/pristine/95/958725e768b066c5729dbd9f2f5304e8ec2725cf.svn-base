import React, { useEffect, useState } from "react";
import config from "../Config";
import { Panel } from "primereact/panel";
import { DataTable } from "primereact/datatable";
import { Column } from "primereact/column";
import { Toolbar } from "primereact/toolbar";
import { Button } from "primereact/button";
import { InputText } from "primereact/inputtext";
import { classNames } from "primereact/utils";
import Potradatos from "./Potradatos";
import axios from "axios";

const Clientes = () => {
  const apiUrl = `${config.apiUrl}/Datasnap/rest/TServerMethods1/ListaClientes`;
  const [clientes, setClientes] = useState([]);
  const [loading, setLoading] = useState(false);
  const [searchTerm, setSearchTerm] = useState("");
  const [errorState, setErrorState] = useState(false);
  const [errorMessage, setErrorMessage] = useState("");
  const [url] = useState(apiUrl);
  const [dialogVisible, setDialogVisible] = useState(false);
  const [selectedClient, setSelectedClient] = useState(null);

  const handleSearch = async () => {
    try {
      setLoading(true);
      const requestData = {
        criterio: searchTerm,
      };

      const response = await axios.put(url, requestData);
      console.log(response.data);
      console.log(response.status);
      if (response.data.status === 200) {
        console.log("ANtes de setClientes:", response.data.data);
        setClientes(response.data.data);
        console.log("Clientes:", response.data.data);
      } else {
        console.error("Error en la respuesta:", response.data.error);
        setErrorMessage(response.data.error);
      }
    } catch (error) {
      if (error.message === "Network Error") {
        setErrorState(true);
        setErrorMessage(
          "Error de red: No se puede conectar al servidor. Por favor, verifica tu conexión a Internet o inténtalo más tarde."
        );
      } else {
        setErrorState(true);
        setErrorMessage(`Error al realizar la solicitud: ${error.message}`);
      }
      console.error("Error al realizar la solicitud:", error.message);
    } finally {
      setLoading(false);
    }
  };

  const handleAcceptPolicy = async (accept) => {
    if (selectedClient) {
      if (accept !== selectedClient.ACEPTAPOTRADATOS) {
        try {
          const response = await axios.post(
            "http://localhost:8080/Datasnap/rest/TServerMethods1/PoTraDatos",
            {
              idcliente: selectedClient.IDCLIENTE,
              aceptapotradatos: accept ? 1 : 0, // Convertir a 1 si se acepta, 0 si no
            }
          );
          console.log(response.data);
          if (response.data.status === 200) {
            // Actualizar el estado del cliente si la solicitud fue exitosa
            setClientes((prevClientes) =>
              prevClientes.map((cliente) =>
                cliente.IDCLIENTE === selectedClient.IDCLIENTE
                  ? { ...cliente, ACEPTAPOTRADATOS: accept ? 1 : 0 }
                  : cliente
              )
            );
          } else {
            console.error("Error en la respuesta:", response.data.error);
            setErrorMessage(response.data.error);
          }
        } catch (error) {
          console.error("Error al realizar la solicitud:", error.message);
          if (error.message === "Network Error") {
            setErrorState(true);
            setErrorMessage(
              "Error de red: No se puede conectar al servidor. Por favor, verifica tu conexión a Internet o inténtalo más tarde."
            );
          } else {
            setErrorState(true);
            setErrorMessage(`Error al realizar la solicitud: ${error.message}`);
          }
        }
      }
    }
  };

  useEffect(() => {
    // Realizar la búsqueda inicial al cargar el componente
    handleSearch();
  }, []);

  const verifiedBodyTemplate = (rowData) => {
    return (
      <i
        className={classNames("pi", {
          "text-green-500 pi-check-circle": rowData.ACEPTAPOTRADATOS,
          "text-red-500 pi-times-circle": !rowData.ACEPTAPOTRADATOS,
        })}
        onClick={() => setDialogVisible(true)}
        style={{ cursor: "pointer" }}
      ></i>
    );
  };

  return (
    <div>
      <h1>Clientes</h1>
      <Panel header="Listado de Clientes" toggleable>
        <Toolbar
          start={
            <>
              <InputText
                placeholder="Buscar..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
              />
              <Button icon="pi pi-search" onClick={handleSearch} />
            </>
          }
        ></Toolbar>
      </Panel>
      <div className="card">
        <DataTable
          value={clientes}
          dataKey="IDCLIENTE"
          loading={loading}
          stripedRows
          emptyMessage="No se han encontrado resultados"
          paginator
          rows={10}
          rowsPerPageOptions={[5, 10, 25, 50]}
          scrollable
          scrollHeight="flex"
          paginatorTemplate="FirstPageLink PrevPageLink PageLinks NextPageLink LastPageLink CurrentPageReport RowsPerPageDropdown"
          currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
          onSelectionChange={(e) => setSelectedClient(e.value)}
        >
          <Column hidden field="IDCLIENTE" header="ID Cliente" />
          <Column field="NOMBRECLIENTE" header="Nombres" />
          <Column field="IDENTIDAD" header="Identidad" />
          <Column field="DIRECCION" header="Dirección" />
          <Column field="TELMOVIL" header="Teléfono" />
          <Column
            field="ACEPTAPOTRADATOS"
            header="Acepta tratamiento"
            bodyClassName="text-center"
            style={{ minWidth: "8rem" }}
            body={verifiedBodyTemplate}
          />
        </DataTable>
      </div>
      <Potradatos
        visible={dialogVisible}
        onHide={() => setDialogVisible(false)}
        onAccept={handleAcceptPolicy}
      />
    </div>
  );
};

export default Clientes;
