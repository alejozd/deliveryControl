import React, { useState, useEffect, useRef } from "react";
import { DataTable } from "primereact/datatable";
import { Column } from "primereact/column";
import { InputText } from "primereact/inputtext";
import { Button } from "primereact/button";
import { Dialog } from "primereact/dialog";
import { Panel } from "primereact/panel";
import { Toolbar } from "primereact/toolbar";
import { Calendar } from "primereact/calendar";
import { FloatLabel } from "primereact/floatlabel";
import { useLocation } from "react-router-dom";
import { Toast } from "primereact/toast";
import PrintQuote from "./PrintQuote";
import config from "../../Config";
import axios from "axios";
import Quoter from "./Quoter";
import WhatsAppDialog from "./WhatsAppDialog";
import EmailDialog from "./EmailDialog";
import setupLocale from "./../../config/localeConfig";
import ComprobantePDF from "./ComprobantePDF";

const QuoterList = () => {
  const location = useLocation();
  const toast = useRef(null);
  const { user } = location.state || {};
  const apiUrl = `${config.apiUrl}/Datasnap/rest/TServerMethods1/ListaCotizaciones`;
  const apiUrlDelCotizacion = `${config.apiUrl}/Datasnap/rest/TServerMethods1/DeleteCotizacionByID`;
  const apiUrlCotizacionByID = `${config.apiUrl}/Datasnap/rest/TServerMethods1/CotizacionByID`;
  const apiUrlDocumentoUsado = `${config.apiUrl}/Datasnap/rest/TServerMethods1/DocUsado`;
  const [selectedQuotation, setSelectedQuotation] = useState(null);
  const [showDialog, setShowDialog] = useState(false);
  const [searchText, setSearchText] = useState("");
  const [fechaIni, setFechaIni] = useState(new Date());
  const [fechaFin, setFechaFin] = useState(new Date());
  const [dates, setDates] = useState([new Date(), new Date()]);
  const [loading, setLoading] = useState(false);
  const [errorState, setErrorState] = useState(false);
  const [errorMessage, setErrorMessage] = useState("");
  const [quoters, setQuoters] = useState([]);
  const [deleteDialogVisible, setDeleteDialogVisible] = useState(false);
  const [quotationToDelete, setQuotationToDelete] = useState(null);
  const [isWhatsAppModalVisible, setIsWhatsAppModalVisible] = useState(false);
  const [isEmailModalVisible, setIsEmailModalVisible] = useState(false);
  const [selectedQuote, setSelectedQuote] = useState(null);
  const [showComprobante, setShowComprobante] = useState(null);
  const [autoGeneratePDF, setAutoGeneratePDF] = useState(false); // Estado para auto-generar PDF

  setupLocale();

  useEffect(() => {
    // Si solo se selecciona una fecha, asignarla tanto como fecha inicial como fecha final
    if (fechaIni && !fechaFin) {
      setFechaFin(fechaIni);
    } else if (!fechaIni && fechaFin) {
      setFechaIni(fechaFin);
    }
  }, [fechaIni, fechaFin]);

  // Función para abrir el diálogo para crear una nueva cotización
  const openCreateDialog = () => {
    setSelectedQuotation(null);
    setShowDialog(true);
  };

  const handleSearch = async () => {
    try {
      setLoading(true);
      const requestData = {
        fechaIni: fechaIni.toLocaleDateString("es-CO", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
        }),
        fechaFin: fechaFin.toLocaleDateString("es-CO", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
        }),
      };
      // console.log('JSON enviado al backend:', requestData);
      const response = await axios.put(apiUrl, requestData);

      if (response.data.status === 200) {
        setQuoters(response.data.data);
        // console.log("Cotizaciones:", response.data.data);
      } else {
        console.error(
          "[QuoterList] - Error en la respuesta:",
          response.data.error
        );
        setErrorMessage(response.data.error);
      }
    } catch (error) {
      if (error.message === "Network Error") {
        setErrorState(true);
        setErrorMessage(
          "No se puede conectar al servidor. Por favor, verifica tu conexión a Internet o inténtalo más tarde."
        );
        console.error("Error de red:", error.message + " " + errorMessage);
      } else {
        setErrorState(true);
        setErrorMessage(`Error al realizar la solicitud: ${error.message}`);
        console.error(errorMessage);
      }
      console.error("Error al realizar la solicitud:", error.message);
    } finally {
      setLoading(false);
    }
  };

  const confirmDelete = async () => {
    try {
      // console.log(quotationToDelete);
      const requestData = {
        idcotizacion: quotationToDelete.idcotizacion,
      };
      const response = await axios.put(apiUrlDelCotizacion, requestData);
      if (response.data.status === 200) {
        // Actualizar la lista de cotizaciones después de la eliminación
        setQuoters(
          quoters.filter(
            (quotation) =>
              quotation.idcotizacion !== quotationToDelete.idcotizacion
          )
        );
        setDeleteDialogVisible(false);
        setQuotationToDelete(null);
      } else {
        console.error("Error al borrar la cotización:", response.data.error);
      }
    } catch (error) {
      console.error("Error al realizar la solicitud:", error);
    }
  };

  const handleDateChange = (e) => {
    setDates(e.value);

    if (e.value && e.value.length > 0) {
      setFechaIni(e.value[0]);
      if (e.value.length === 2) {
        setFechaFin(e.value[1]);
      } else {
        setFechaFin(e.value[0]);
      }
    } else {
      setFechaIni(null);
      setFechaFin(null);
    }
  };

  const editQuotation = async (rowData) => {
    try {
      // Realizar la solicitud al endpoint usando axios
      const requestData = {
        documento: rowData.docufull,
        fecha: rowData.fechacotizacion,
      };
      // console.log("JSON enviado al backend:", requestData);
      const response = await axios.put(apiUrlDocumentoUsado, requestData);

      // Aquí se asume que `response.data` contiene el JSON con `docusado` y `status`
      const { docusado, status } = response.data;

      if (status === 200) {
        if (docusado === 0) {
          // Si docusado es 0, permitir la edición
          setSelectedQuotation(rowData);
          setShowDialog(true);
        } else if (docusado === 1) {
          // Si docusado es 1, mostrar mensaje de advertencia
          toast.current.show({
            severity: "warn",
            summary: "Advertencia",
            detail: `El documento ${rowData.docufull} ya ha sido usado y no se puede modificar.`,
            life: 3500,
          });
        }
      } else {
        // Manejo de un posible error en el status
        toast.current.show({
          severity: "error",
          summary: "Error",
          detail:
            "Hubo un problema al verificar el documento. Inténtalo de nuevo más tarde.",
          life: 3000,
        });
      }
    } catch (error) {
      // Manejo de errores de red o del servidor
      toast.current.show({
        severity: "error",
        summary: "Error",
        detail:
          "Error al comunicarse con el servidor. Revisa tu conexión e inténtalo de nuevo.",
        life: 3000,
      });
      console.error("Error al verificar el documento usado:", error);
    }
  };

  const deleteQuotation = (rowData) => {
    setQuotationToDelete(rowData);
    setDeleteDialogVisible(true);
  };

  const printQuotation = async (rowData) => {
    try {
      setLoading(true);
      const idcotizacion = rowData.idcotizacion;
      const response = await axios.put(apiUrlCotizacionByID, { idcotizacion });
      // console.log("response:", response.data);
      if (response.data.status === 200) {
        const { cliente, productos } = response.data;

        const quotation = {
          numerocotizacion: cliente.numerocotizacion || "",
          fecha: cliente.fechacotizacion || "",
          nombrecliente: cliente.nombrecliente || "",
          identidad: cliente.identidad || "",
          direccion: cliente.direccion || "",
          telmovil: cliente.telmovil || "",
          email: cliente.email || "",
          notas: cliente.notas || "",
          productos: productos.map((productos) => ({
            nombreproductos: productos.nombreproductos,
            referencia: productos.referencia,
            precio: productos.precio,
            cantidad: productos.cantidad,
            total: productos.total,
          })),
        };
        // console.log("quotation:", quotation);
        setTimeout(() => {
          PrintQuote({ quoteData: quotation });
        }, 100); // Se añade un pequeño retraso para asegurar que el estado se actualice antes de imprimir
      } else {
        setErrorMessage(response.data.error || "Error en la respuesta");
      }
    } catch (error) {
      setErrorMessage("Error al realizar la solicitud: " + error.message);
    } finally {
      setLoading(false);
    }
  };

  const handleSaveQuotation = () => {
    setShowDialog(false);
    handleSearch();
  };

  const openWhatsAppModal = async (quote) => {
    setLoading(true);
    const { success, quotation, errorMessage } = await fetchQuotation(quote);
    if (success) {
      setSelectedQuote(quotation);
      setIsWhatsAppModalVisible(true);
    } else {
      setErrorMessage(errorMessage);
    }
    setLoading(false);
  };

  const openEmailModal = async (quote) => {
    setLoading(true);
    const { success, quotation, errorMessage } = await fetchQuotation(quote);
    if (success) {
      setSelectedQuote(quotation);
      setIsEmailModalVisible(true);
    } else {
      setErrorMessage(errorMessage);
    }
    setLoading(false);
  };

  const fetchQuotation = async (rowData) => {
    try {
      const response = await axios.put(apiUrlCotizacionByID, {
        idcotizacion: rowData.idcotizacion,
      });
      if (response.data.status === 200) {
        const { cliente, productos } = response.data;
        const quotation = {
          numerocotizacion: cliente.numerocotizacion || "",
          fecha: cliente.fechacotizacion || "",
          cliente: {
            idcliente: cliente.idcliente || "",
            nombre: cliente.nombrecliente || "",
            identidad: cliente.identidad || "",
            direccion: cliente.direccion || "",
            telmovil: cliente.telmovil || "",
            email: cliente.email || "",
            notas: cliente.notas || "",
          },
          productos: productos.map((producto) => ({
            nombre: producto.nombreproductos,
            referencia: producto.referencia,
            precio: producto.precio,
            cantidad: producto.cantidad,
            total: producto.total,
          })),
          total: rowData.total || 0,
        };
        return { success: true, quotation };
      } else {
        return {
          success: false,
          errorMessage: response.data.error || "Error en la respuesta",
        };
      }
    } catch (error) {
      return {
        success: false,
        errorMessage: "Error al realizar la solicitud: " + error.message,
      };
    }
  };

  const handleShowComprobante = async (rowData, autoGenerate = false) => {
    // console.log("handleShowComprobante:", rowData);
    try {
      setLoading(true);
      const { success, quotation, errorMessage } = await fetchQuotation(
        rowData
      );

      if (success) {
        // Restablecer el estado antes de actualizarlo
        setAutoGeneratePDF(false);
        setShowComprobante(null);

        // Usar un timeout para asegurar que el estado se restablezca antes de actualizarlo
        setTimeout(() => {
          setAutoGeneratePDF(autoGenerate);
          setShowComprobante(quotation);
        }, 0);
      } else {
        setErrorMessage(errorMessage);
      }
    } catch (error) {
      setErrorMessage("Error al realizar la solicitud: " + error.message);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    if (autoGeneratePDF && showComprobante) {
      // Aquí puedes manejar la lógica para generar el PDF automáticamente
      // Por ejemplo, llamar a una función en ComprobantePDF para generar el PDF
    }
  }, [autoGeneratePDF, showComprobante]);

  const actionbodyTemplate = (rowData) => {
    return (
      <React.Fragment>
        <Button
          icon="pi pi-whatsapp"
          severity="success"
          rounded
          text
          onClick={() => openWhatsAppModal(rowData)}
        />
        <Button
          icon="pi pi-envelope"
          severity="secondary"
          rounded
          text
          onClick={() => openEmailModal(rowData)}
        />
        <Button
          icon="pi pi-file-pdf"
          rounded
          text
          severity="danger"
          onClick={() => handleShowComprobante(rowData)}
        />
      </React.Fragment>
    );
  };

  const formatCurrency = (value) => {
    return value.toLocaleString("es-CO", {
      style: "currency",
      currency: "COP",
    });
  };

  const totalBodyTemplate = (quoters) => {
    return formatCurrency(quoters.total);
  };

  return (
    <div className="p-grid">
      <Toast ref={toast} />
      {/* Barra de búsqueda */}
      <div>
        <Panel header="Cotizaciones" toggleable>
          <Toolbar
            start={
              <div style={{ marginTop: "10px" }}>
                <FloatLabel>
                  <Calendar
                    id="fechaCotizaciones"
                    style={{ marginTop: "10px" }}
                    value={dates}
                    onChange={handleDateChange}
                    // locale="es"
                    selectionMode="range"
                    showIcon
                    readOnlyInput
                    dateFormat="dd/mm/yy"
                    hideOnRangeSelection
                    placeholder="Rango de fechas"
                  />
                  <label htmlFor="fechaCotizaciones">Rango de fechas</label>
                </FloatLabel>
              </div>
            }
            end={
              <div style={{ marginTop: "13px" }}>
                <FloatLabel>
                  <InputText
                    style={{ width: "320px" }}
                    id="searchCriteria"
                    // placeholder="Cotización, cédula/nit o nombre cliente"
                    value={searchText}
                    onChange={(e) => setSearchText(e.target.value)}
                    className="mobile-input"
                  />
                  <label htmlFor="searchCriteria">
                    Cotización, cédula/nit o nombre cliente
                  </label>
                  <Button
                    label="Buscar"
                    icon="pi pi-search"
                    className="p-mt-2"
                    loading={loading}
                    onClick={handleSearch}
                    style={{ marginLeft: "5px" }}
                  />
                </FloatLabel>
              </div>
            }
          />
        </Panel>
        <div className="p-col-12" style={{ marginTop: "5px" }}>
          <Panel>
            <Toolbar
              end={
                <div className="flex align-items-center gap-2">
                  <Button
                    label="Nueva"
                    icon="pi pi-plus"
                    severity="success"
                    onClick={openCreateDialog}
                    // className="p-button-raised p-button-primary"
                    raised
                    // rounded
                    style={{ marginTop: "-10px", marginBottom: "-10px" }}
                  />
                  <Button
                    label="Editar"
                    icon="pi pi-pencil"
                    disabled={!selectedQuotation}
                    onClick={() => editQuotation(selectedQuotation)}
                  />
                  <Button
                    label="Eliminar"
                    icon="pi pi-trash"
                    severity="danger"
                    disabled={!selectedQuotation}
                    onClick={() => deleteQuotation(selectedQuotation)}
                  />
                  <Button
                    label="Imprimir"
                    icon="pi pi-print"
                    severity="help"
                    disabled={!selectedQuotation}
                    onClick={() => printQuotation(selectedQuotation)}
                  />
                </div>
              }
            />
          </Panel>
        </div>
      </div>

      {/* Grilla de cotizaciones */}
      <div className="p-col-12">
        <DataTable
          value={quoters}
          selectionMode="single"
          selection={selectedQuotation}
          onSelectionChange={(e) => setSelectedQuotation(e.value)}
          scrollable
          paginator
          rows={10}
          rowsPerPageOptions={[5, 10, 25]}
          emptyMessage="No hay cotizaciones disponibles"
          paginatorTemplate="FirstPageLink PrevPageLink PageLinks NextPageLink LastPageLink CurrentPageReport RowsPerPageDropdown"
          currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
        >
          <Column field="idcotizacion" header="ID" hidden />
          <Column
            field="numerocotizacion"
            header="Número de Cotización"
            sortable
            style={{ width: "124px", minWidth: "124px" }}
          />
          <Column field="fechacotizacion" header="Fecha" sortable />
          <Column field="nit" header="Identificación" sortable />
          <Column field="nombrecliente" header="Nombre del Cliente" sortable />
          <Column
            field="total"
            header="Total"
            body={totalBodyTemplate}
            sortable
            align={"right"}
          />
          <Column
            body={actionbodyTemplate}
            style={{ minWidth: "10rem" }}
            alignFrozen="right"
            frozen={true}
          />
        </DataTable>
      </div>

      {/* Diálogo para crear una nueva cotización */}
      <Dialog
        visible={showDialog}
        onHide={() => setShowDialog(false)}
        header={
          selectedQuotation
            ? `Editar Cotización - N° ${selectedQuotation.numerocotizacion}`
            : "Crear Nueva Cotización"
        }
        maximizable
        style={{ width: "80vw" }}
        closeOnEscape={false}
      >
        <Quoter
          onSave={handleSaveQuotation}
          quotationData={selectedQuotation}
          user={user}
        />
      </Dialog>

      {/* Diálogo de confirmación */}
      <Dialog
        visible={deleteDialogVisible}
        onHide={() => setDeleteDialogVisible(false)}
        footer={
          <div>
            <Button
              label="No"
              icon="pi pi-times"
              className="p-button-text"
              onClick={() => setDeleteDialogVisible(false)}
            />
            <Button
              label="Sí"
              icon="pi pi-check"
              onClick={confirmDelete}
              severity="danger"
            />
          </div>
        }
        header="Confirmar Eliminación"
        closeOnEscape={false}
      >
        <p className="m-0">
          <i
            className="pi pi-exclamation-triangle mr-2"
            style={{ fontSize: "2rem" }}
          ></i>
          ¿Está seguro de que desea eliminar esta cotización{" "}
          <strong>No.</strong>{" "}
          <strong>
            {selectedQuotation ? selectedQuotation.numerocotizacion : ""}?
          </strong>
        </p>
      </Dialog>
      <WhatsAppDialog
        visible={isWhatsAppModalVisible}
        onHide={() => setIsWhatsAppModalVisible(false)}
        selectedQuote={selectedQuote}
      />
      <EmailDialog
        visible={isEmailModalVisible}
        onHide={() => setIsEmailModalVisible(false)}
        selectedQuote={selectedQuote}
      />
      {/* Diálogo para mostrar el comprobante */}
      <Dialog
        visible={!!showComprobante && !autoGeneratePDF}
        onHide={() => setShowComprobante(null)}
        maximizable
        style={{ width: "80vw", minHeight: "60vh" }}
        closeOnEscape={false}
      >
        {showComprobante && (
          <ComprobantePDF
            datos={showComprobante}
            autoGenerate={autoGeneratePDF}
          />
        )}
      </Dialog>

      {/* Componente oculto para generar PDF automáticamente */}
      {autoGeneratePDF && (
        <ComprobantePDF
          datos={showComprobante}
          autoGenerate={autoGeneratePDF}
        />
      )}
    </div>
  );
};

export default QuoterList;
