import React, { useState, useEffect } from 'react';
import { DataTable } from 'primereact/datatable';
import { Column } from 'primereact/column';
import { Panel } from 'primereact/panel';
import { Calendar } from 'primereact/calendar';
import { Button } from 'primereact/button';
import { Toolbar } from 'primereact/toolbar';
import { addLocale } from 'primereact/api';
import { Dialog } from 'primereact/dialog';
import config from '../../Config';
import axios from 'axios';

const ConsultaPedientesEntrega = () => {
    const apiUrl = `${config.apiUrl}/Datasnap/rest/TServerMethods1/ListaRefEntregar`;
    const [pendientes, setPendientes] = useState([]);
    const [loading, setLoading] = useState(false);
    const [dates, setDates] = useState(null);
    const [fechaIni, setFechaIni] = useState(null);
    const [fechaFin, setFechaFin] = useState(null);
    const [errorState, setErrorState] = useState(false);
    const [errorMessage, setErrorMessage] = useState('');

    addLocale('es', {
        firstDayOfWeek: 1,
        //showMonthAfterYear: true,
        dayNames: ['domingo', 'lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado'],
        dayNamesShort: ['dom', 'lun', 'mar', 'mié', 'jue', 'vie', 'sáb'],
        dayNamesMin: ['D', 'L', 'M', 'X', 'J', 'V', 'S'],
        monthNames: ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'],
        monthNamesShort: ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'],
        today: 'Hoy',
        clear: 'Limpiar'
    });

    const handleCloseErrorDialog = () => {
        setErrorState(false);
        setErrorMessage('');
    };

    const handleSearch = async () => {
        try {
            setLoading(true);
            const requestData = {
                fechaIni: fechaIni.toLocaleDateString("es-CO", { day: '2-digit', month: '2-digit', year: 'numeric' }),
                fechaFin: fechaFin.toLocaleDateString("es-CO", { day: '2-digit', month: '2-digit', year: 'numeric' }),
            };
            // console.log('JSON enviado al backend:', requestData);
            // const response = await axios.put('http://192.168.20.38:8080/Datasnap/rest/TServerMethods1/ListaEntregas', requestData);
            const response = await axios.put(apiUrl, requestData);

            if (response.data.status === 200) {
                setPendientes(response.data.data);
                // console.log('Entregas:', response.data.data);
            } else {
                console.error('Error en la respuesta:', response.data.error);
                setErrorMessage(response.data.error);
            }
        } catch (error) {
            if (error.message === "Network Error") {
                setErrorState(true);
                setErrorMessage("Error de red: No se puede conectar al servidor. Por favor, verifica tu conexión a Internet o inténtalo más tarde.");
            } else {
                setErrorState(true);
                setErrorMessage(`Error al realizar la solicitud: ${error.message}`);
            }
            console.error('Error al realizar la solicitud:', error.message);
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        // Si solo se selecciona una fecha, asignarla tanto como fecha inicial como fecha final
        if (fechaIni && !fechaFin) {
            setFechaFin(fechaIni);
        } else if (!fechaIni && fechaFin) {
            setFechaIni(fechaFin);
        }
    }, [fechaIni, fechaFin]);

    const handleDateChange = (e) => {
        setDates(e.value);

        if (e.value && e.value.length > 0) {
            setFechaIni(e.value[0]);
            if (e.value.length === 2) {
                setFechaFin(e.value[1]);
            } else {
                setFechaFin(e.value[0]);
            }
        } else {
            setFechaIni(null);
            setFechaFin(null);
        }
    };

    return (
        <div>
            <Panel header="Consulta Referencias Pendientes por Entregar" toggleable>
                <Toolbar
                    start={
                        <>
                            <Calendar value={dates}
                                onChange={handleDateChange}
                                locale="es"
                                selectionMode="range"
                                showIcon
                                readOnlyInput
                                dateFormat="dd/mm/yy"
                            />
                        </>
                    }
                    end={
                        <>
                            <Button label="Buscar"
                                icon="pi pi-search"
                                className="p-mt-2"
                                loading={loading}
                                onClick={handleSearch} />
                        </>
                    }
                />
            </Panel>
            <DataTable value={pendientes} emptyMessage="No se han encontrado resultados" showGridlines stripedRows className="p-datatable-sm"
                paginator rows={10} rowsPerPageOptions={[5, 10, 25, 50]}>
                <Column field="numfactura" header="Documento" />
                <Column field="referencia" header="Referencia" />
                <Column field="nombreproducto" header="Nombre Articulo" />
                <Column field="saldo" header="Cant. Pendiente" />
                <Column field="nombrecliente" header="Cliente" />
                <Column field="identidad" header="Identidad" />
            </DataTable>
            <Dialog
                visible={errorState}
                onHide={handleCloseErrorDialog}
                header="Error"
                modal
                style={{ width: '300px' }}
            >
                <div>
                    <p>{errorMessage}</p>
                    <Button label="Cerrar" icon="pi pi-times"
                        severity='danger'
                        text
                        style={{ marginTop: '10px' }}
                        size="small"
                        onClick={handleCloseErrorDialog} />
                </div>
            </Dialog>
        </div>
    );


};
export default ConsultaPedientesEntrega;