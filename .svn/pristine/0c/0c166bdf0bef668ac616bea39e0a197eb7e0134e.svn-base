// src/components/ClientContactAssociation.js
import React, { useState, useEffect, useRef } from "react";
import { PickList } from "primereact/picklist";
import { Button } from "primereact/button";
import { Dropdown } from "primereact/dropdown";
import { Panel } from "primereact/panel";
import { Card } from "primereact/card";
import { InputText } from "primereact/inputtext";
import { FloatLabel } from "primereact/floatlabel";
import { Toast } from "primereact/toast";
import config from "../Config";
import axios from "axios";

const ClientContactAssociation = () => {
  const apiUrl = `${config.apiUrl}/Datasnap/rest/TServerMethods1/ListaClientes`;
  const apiUrlContactosCliente = `${config.apiUrl}/Datasnap/rest/TServerMethods1/DataContactosCliente`;
  const apiUrlListaContactos = `${config.apiUrl}/Datasnap/rest/TServerMethods1/ListaContactos`;
  const apiUrlGuardarAsociaciones = `${config.apiUrl}/Datasnap/rest/TServerMethods1/AsociarContacto`;
  const [clientes, setClientes] = useState([]);
  const [selectedCliente, setSelectedCliente] = useState(null);
  const [contactos, setContactos] = useState([]);
  const [contactosAsociados, setContactosAsociados] = useState([]);
  const [searchTerm, setSearchTerm] = useState(""); //Cliente para buscar
  const [loading, setLoading] = useState(false);
  const toast = useRef(null);

  const fetchClientes = async (term) => {
    setLoading(true);
    try {
      const requestData = { criterio: term };
      const response = await axios.put(apiUrl, requestData);
      const formattedClientes = response.data.data.map((cliente) => ({
        label: `${cliente.nombrecliente} (${cliente.identidad})`,
        value: cliente.idcliente,
      }));
      setClientes(formattedClientes);
    } catch (error) {
      console.error("Error fetching clientes:", error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    const delayDebounceFn = setTimeout(() => {
      if (searchTerm.length > 0) {
        fetchClientes(searchTerm);
      } else {
        setClientes([]);
      }
    }, 300); // 300 ms de espera

    return () => clearTimeout(delayDebounceFn); // Limpiar el timeout si el usuario sigue escribiendo
  }, [searchTerm]);

  const onClienteChange = async (e) => {
    const clienteId = e.value;
    setSelectedCliente(clienteId);

    try {
      // Cargar los contactos disponibles
      const responseContactos = await axios.put(apiUrlListaContactos, {
        criterio: "",
      });

      // Asegúrate de que responseContactos.data es un array
      const contactosDisponibles = Array.isArray(responseContactos.data.data)
        ? responseContactos.data.data
        : [];

      // Cargar los contactos asociados
      const responseContactosAsociados = await axios.put(
        apiUrlContactosCliente,
        {
          idcliente: clienteId,
        }
      );

      const contactosAsociados =
        responseContactosAsociados.data.contactos || [];

      // Obtener los IDs de los contactos asociados
      const contactosAsociadosIds = contactosAsociados.map(
        (contacto) => contacto.idcontacto
      );

      // Filtrar los contactos disponibles para excluir los ya asociados
      const contactosFiltrados = contactosDisponibles.filter(
        (contacto) => !contactosAsociadosIds.includes(contacto.idcontacto)
      );

      // Actualizar los estados
      setContactos(contactosFiltrados); // Contactos no asociados al cliente
      setContactosAsociados(contactosAsociados); // Solo los contactos asociados
    } catch (error) {
      console.error("Error fetching contactos:", error);
    }
  };

  const onMoveToTarget = (event) => {
    console.log("Event object:", event);
    if (!event || !event.value) {
      console.error("Event object or its properties are undefined:", event);
      return;
    }

    const movedItems = event.value; // Obtener los elementos movidos
    const updatedContactos = contactos.filter(
      (item) =>
        !movedItems.some(
          (movedItem) => movedItem.idcontacto === item.idcontacto
        )
    );
    const updatedContactosAsociados = [...contactosAsociados, ...movedItems];

    setContactos(updatedContactos);
    setContactosAsociados(updatedContactosAsociados);
  };

  const onMoveToSource = (event) => {
    console.log("Event object:", event);
    if (!event || !event.value) {
      console.error("Event object or its properties are undefined:", event);
      return;
    }

    const movedItems = event.value; // Obtener los elementos movidos
    const updatedContactos = [...contactos, ...movedItems];
    const updatedContactosAsociados = contactosAsociados.filter(
      (item) =>
        !movedItems.some(
          (movedItem) => movedItem.idcontacto === item.idcontacto
        )
    );

    setContactos(updatedContactos);
    setContactosAsociados(updatedContactosAsociados);
  };

  const handleSave = async () => {
    if (!selectedCliente) {
      alert("Por favor, seleccione un cliente.");
      return;
    }

    // Extraer los IDs de los contactos asociados
    const contactosAsociadosIds = contactosAsociados.map(
      (contacto) => contacto.idcontacto
    );

    const contactosAsociadosData = contactosAsociadosIds.map((id) => {
      return { idcontacto: id };
    });

    console.log("contactosAsociadosData", contactosAsociadosData);

    try {
      // Enviar los datos al backend
      const response = await axios.put(apiUrlGuardarAsociaciones, {
        idcliente: selectedCliente,
        contactos: contactosAsociadosData,
      });

      console.log("response", response);

      if (response.data.status === 200) {
        console.log("Asociaciones guardadas:", response.data);
        toast.current.show({
          severity: "success",
          summary: "Éxito",
          detail: "Contacto asociado correctamente",
          life: 3000,
        });
      } else {
        console.error("Error al guardar las asociaciones:", response.data);
        toast.current.show({
          severity: "error",
          summary: "Error",
          detail: "No se pudo agregar el contacto",
          life: 3000,
        });
      }
    } catch (error) {
      console.error("Error guardando asociaciones:", error);
      alert("Error al guardar las asociaciones.");
    }
  };

  const itemTemplate = (item) => {
    return (
      <Card>
        <div className="p-grid p-nogutter">
          <div
            className="p-col-12"
            style={{ display: "flex", justifyContent: "space-between" }}
          >
            <div style={{ fontSize: "0.9em" }}>
              <strong>Nombre:</strong> {item.nombreCa}
            </div>
            <div style={{ fontSize: "0.8em" }}>
              <strong>Identidad:</strong> {item.identificacionCa}
            </div>
          </div>
          <div
            className="p-col-12"
            style={{ display: "flex", justifyContent: "space-between" }}
          >
            <div style={{ fontSize: "0.8em" }}>
              <strong>Correo:</strong> {item.correoCa}
            </div>
            <div style={{ fontSize: "0.8em" }}>
              <strong>Teléfono:</strong> {item.telmovilCa}
            </div>
          </div>
        </div>
      </Card>
    );
  };

  return (
    <div>
      <Toast ref={toast} />
      <h1>Asociar Clientes y Contactos</h1>
      <Panel header="Seleccionar Cliente" toggleable>
        <Card>
          <div
            className="flex align-items-center justify-content-between"
            style={{ paddingTop: "10px" }}
          >
            <div className="p-inputgroup">
              <FloatLabel>
                <InputText
                  id="buscarclientes"
                  placeholder="Buscar cliente..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                />
                {loading && (
                  <i
                    className="pi pi-spin pi-spinner"
                    style={{ marginLeft: "10px" }}
                  ></i>
                )}
                <label htmlFor="buscarclientes">Buscar cliente...</label>
              </FloatLabel>
            </div>
            <div className="p-inputgroup ml-2">
              <FloatLabel>
                <Dropdown
                  inputId="clientes"
                  // id="idcliente"
                  value={selectedCliente}
                  onChange={onClienteChange}
                  options={clientes}
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Seleccione un cliente"
                  filter
                  filterBy="label"
                  loading={loading}
                  style={{ borderRadius: "4px" }}
                />
                <label htmlFor="clientes">Seleccione un cliente</label>
              </FloatLabel>
            </div>
          </div>
        </Card>
      </Panel>
      <div style={{ paddingTop: "10px" }}>
        <Card>
          <PickList
            dataKey="idcontacto"
            source={contactos}
            target={contactosAsociados}
            // itemTemplate={(item) => <span>{item.nombreCa}</span>}
            itemTemplate={itemTemplate}
            filter
            filterBy="nombreCa,identificacionCa,telmovilCa,correoCa"
            sourceHeader="Contactos Disponibles"
            targetHeader="Contactos Asociados"
            sourceStyle={{ height: "200px" }}
            targetStyle={{ height: "200px" }}
            onMoveToTarget={onMoveToTarget}
            onMoveToSource={onMoveToSource}
            showSourceControls={false}
            showTargetControls={false}
            sourceFilterPlaceholder="Buscar por nombre, identidad, teléfono o correo"
            targetFilterPlaceholder="Buscar por nombre, identidad, teléfono o correo"
            // sourceFilterPlaceholder="Buscar por nombre"
            // targetFilterPlaceholder="Buscar por nombre"
            pt={{
              moveAllToTargetButton: {
                root: { className: "hidden" },
              },
              moveAllToSourceButton: {
                root: { className: "hidden" },
              },
            }}
          />
        </Card>
        <div style={{ paddingTop: "10px" }}>
          <Card>
            <Button
              onClick={handleSave}
              label="Asociar Contactos"
              icon="pi pi-save"
              className="p-button-success"
            />
          </Card>
        </div>
      </div>
    </div>
  );
};

export default ClientContactAssociation;
