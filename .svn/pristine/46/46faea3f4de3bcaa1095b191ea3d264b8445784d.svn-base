import React, { useState } from "react";
import axios from "axios";
import { useFormik } from "formik";
import * as Yup from "yup";
import { InputText } from "primereact/inputtext";
import { Password } from "primereact/password";
import { Button } from "primereact/button";
import config from "./Config";
import "./Login.css";

const Login = ({ onLoginSuccess }) => {
  const [loading, setLoading] = useState(false);
  const [errorMessage, setErrorMessage] = useState("");
  const apiUrl = `${config.apiUrl}/Datasnap/rest/TServerMethods1/Login`;

  const validationSchema = Yup.object({
    nombre: Yup.string().required("El nombre de usuario es obligatorio"),
    clave: Yup.string().required("La contraseña es obligatoria"),
  });

  const formik = useFormik({
    initialValues: {
      nombre: "",
      clave: "",
    },
    validationSchema: validationSchema,
    onSubmit: async (values) => {
      try {
        setLoading(true);
        // console.log('JSON enviado al backend:', values);
        // const response = await axios.post('http://192.168.20.38:8080/Datasnap/rest/TServerMethods1/Login', values);
        const response = await axios.post(apiUrl, values);
        if (response.data.status === 200) {
          console.log("JSON recibido del backend:", response.data);
          const user = {
            name: response.data.nombre,
            codigo: response.data.codigo,
            modvencli: response.data.modvencli,
          };
          console.log(`Inicio de sesión exitoso para el usuario: ${user.name}`);
          onLoginSuccess(user);
        } else {
          setErrorMessage(response.data.error);
          // console.error(response.data.error);
        }
      } catch (error) {
        const errorMsg =
          error.message === "Network Error"
            ? "Error de red: No se puede conectar al servidor. Por favor, verifica tu conexión a Internet o inténtalo más tarde."
            : `Error al realizar la solicitud: ${error.message}`;
        setErrorMessage(errorMsg);
        console.error("Error al realizar la solicitud:", error.message);
      } finally {
        setLoading(false);
      }
    },
  });

  return (
    <div className="login-container">
      <form onSubmit={formik.handleSubmit}>
        <div className="login-form">
          <div className="w-full text-center text-3xl font-bold md:text-4xl md:mb-10">
            Bienvenido
          </div>
          <div className="flex flex-column md:flex-row">
            <div className="w-full md:w-5 md:mx-auto flex flex-column align-items-center justify-content-center gap-3 py-5">
              <div className="flex flex-wrap gap-2">
                <label htmlFor="nombre">Usuario</label>
                <InputText
                  id="nombre"
                  name="nombre"
                  type="text"
                  className="w-17rem"
                  onChange={formik.handleChange}
                  onBlur={formik.handleBlur}
                  value={formik.values.nombre}
                  aria-describedby="nombre-help"
                />
                {formik.touched.nombre && formik.errors.nombre && (
                  <div className="error-message" id="nombre-help">
                    {formik.errors.nombre}
                  </div>
                )}
              </div>
              <div className="flex flex-wrap gap-2 ">
                <label htmlFor="clave">Contraseña</label>
                <Password
                  id="clave"
                  name="clave"
                  feedback={false}
                  toggleMask
                  onChange={formik.handleChange}
                  onBlur={formik.handleBlur}
                  value={formik.values.clave}
                  aria-describedby="clave-help"
                />
                {formik.touched.clave && formik.errors.clave && (
                  <div className="error-message">{formik.errors.clave}</div>
                )}
                <div className="flex flex-wrap gap-2 w-full justify-content-center">
                  <Button
                    type="submit"
                    label="Login"
                    icon="pi pi-user"
                    className="w-10rem mx-auto"
                    loading={loading}
                  ></Button>
                  {/* {loading && <p className="loading-message">Cargando...</p>} */}
                  {errorMessage && (
                    <p className="error-message">{errorMessage}</p>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  );
};

export default React.memo(Login);
